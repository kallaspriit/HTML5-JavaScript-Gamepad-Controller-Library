!function(a){"use strict";var b=function(){},c={isSupported:function(){return!1},update:b,getMapping:function(){return null}},d=function(a){var c=this,d=window;this.update=b;this.requestAnimationFrame=a||d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.mozRequestAnimationFrame;this.tickFunction=function(){c.update();c.startTicker()};this.startTicker=function(){c.requestAnimationFrame.apply(d,[c.tickFunction])}};d.prototype.start=function(a){this.update=a||b;this.startTicker()};var e=function(){};e.prototype.update=b;e.prototype.start=function(a){this.update=a||b};var f=function(a,b){this.listener=a;this.gamepadGetter=b;this.knownGamepads=[]};f.factory=function(a){var b=c,d=window&&window.navigator;d&&("undefined"!=typeof d.webkitGamepads?b=new f(a,function(){return d.webkitGamepads}):"undefined"!=typeof d.webkitGetGamepads&&(b=new f(a,function(){return d.webkitGetGamepads()})));return b};f.prototype.isSupported=function(){return!0};f.prototype.update=function(){var a,b,c=this,d=Array.prototype.slice.call(this.gamepadGetter(),0);for(b=this.knownGamepads.length-1;b>=0;b--){a=this.knownGamepads[b];if(d.indexOf(a)<0){this.knownGamepads.splice(b,1);this.listener._disconnect(a)}}for(b=0;b<d.length;b++){a=d[b];if(a&&c.knownGamepads.indexOf(a)<0){c.knownGamepads.push(a);c.listener._connect(a)}}};f.prototype.getMapping=function(a){return a===h.Type.LOGITECH?h.Mapping.LOGITECH_WEBKIT:a===h.Type.PLAYSTATION?h.Mapping.PLAYSTATION_WEBKIT:null};var g=function(a){this.listener=a;window.addEventListener("MozGamepadConnected",function(b){a._connect(b.gamepad)});window.addEventListener("MozGamepadDisconnected",function(b){a._disconnect(b.gamepad)})};g.factory=function(a){var b=c;window&&"undefined"!=typeof window.addEventListener&&(b=new g(a));return b};g.prototype.isSupported=function(){return!0};g.prototype.update=b;g.prototype.getMapping=function(a){return a===h.Type.LOGITECH?h.Mapping.LOGITECH_FIREFOX:a===h.Type.PLAYSTATION?h.Mapping.PLAYSTATION_FIREFOX:null};var h=function(a){this.updateStrategy=a||new d;this.gamepads=[];this.listeners={};this.platform=c;this.deadzone=.03;this.maximizeThreshold=.97};h.UpdateStrategies={AnimFrameUpdateStrategy:d,ManualUpdateStrategy:e};h.PlatformFactories=[f.factory,g.factory];h.Type={PLAYSTATION:"playstation",LOGITECH:"logitech",XBOX:"xbox",UNSUPPORTED:"unsupported"};h.Event={CONNECTED:"connected",UNSUPPORTED:"unsupported",DISCONNECTED:"disconnected",TICK:"tick",BUTTON_DOWN:"button-down",BUTTON_UP:"button-up",AXIS_CHANGED:"axis-changed"};h.Mapping={PLAYSTATION_FIREFOX:{buttons:{CROSS:14,CIRCLE:13,SQUARE:15,TRIANGLE:12,LB1:10,RB1:11,LEFT_STICK:1,RIGHT_STICK:2,START:3,SELECT:0,HOME:16,DPAD_UP:4,DPAD_DOWN:6,DPAD_LEFT:7,DPAD_RIGHT:5},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},PLAYSTATION_WEBKIT:{buttons:{CROSS:0,CIRCLE:1,SQUARE:2,TRIANGLE:3,LB1:4,RB1:5,LB2:6,RB2:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,SELECT:8,HOME:16,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},LOGITECH_FIREFOX:{buttons:{A:0,B:1,X:2,Y:3,LB:4,RB:5,LEFT_STICK:8,RIGHT_STICK:9,START:7,BACK:6,HOME:10,DPAD_UP:11,DPAD_DOWN:12,DPAD_LEFT:13,DPAD_RIGHT:14},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:3,RIGHT_STICK_Y:4,LEFT_TRIGGER:function(a,b){return a.axes[2]>0?b._applyDeadzoneMaximize(a.axes[2]):0},RIGHT_TRIGGER:function(a,b){return a.axes[2]<0?b._applyDeadzoneMaximize(-1*a.axes[2]):0}}},LOGITECH_WEBKIT:{buttons:{A:1,B:2,X:0,Y:3,LB:4,RB:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,BACK:8,HOME:10,DPAD_UP:11,DPAD_DOWN:12,DPAD_LEFT:13,DPAD_RIGHT:14},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},XBOX:{buttons:{A:0,B:1,X:2,Y:3,LB:4,RB:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,BACK:8,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,HOME:16},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}}};h.prototype.init=function(){var a=h.resolvePlatform(this),b=this;this.platform=a;this.updateStrategy.start(function(){b._update()});return a.isSupported()};h.prototype.bind=function(a,b){"undefined"==typeof this.listeners[a]&&(this.listeners[a]=[]);this.listeners[a].push(b);return this};h.prototype.unbind=function(a,b){if("undefined"!=typeof a){if("undefined"!=typeof b){if("undefined"==typeof this.listeners[a])return!1;for(var c=0;c<this.listeners[a].length;c++)if(this.listeners[a][c]===b){this.listeners[a].splice(c,1);return!0}return!1}this.listeners[a]=[]}else this.listeners={}};h.prototype.count=function(){return this.gamepads.length};h.prototype._fire=function(a,b){if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c].apply(this.listeners[a][c],[b])};h.getNullPlatform=function(){return Object.create(c)};h.resolvePlatform=function(a){var b,d=c;for(b=0;!d.isSupported()&&b<h.PlatformFactories.length;b++)d=h.PlatformFactories[b](a);return d};h.prototype._getMapping=function(a){return a===h.Type.XBOX?h.Mapping.XBOX:this.platform.getMapping(a)};h.prototype._connect=function(a){a.type=this._resolveControllerType(a.id);if(a.type===h.Type.UNSUPPORTED){this._fire(h.Event.UNSUPPORTED,a);return!1}a.mapping=this._getMapping(a.type);if(null===a.mapping){this._fire(h.Event.UNSUPPORTED,a);return!1}a.state={};a.lastState={};a.downButtons=[];var b,c;for(b in a.mapping.buttons){a.state[b]=0;a.lastState[b]=0}for(c in a.mapping.axes){a.state[c]=0;a.lastState[c]=0}this.gamepads[a.index]=a;this._fire(h.Event.CONNECTED,a);return!0};h.prototype._disconnect=function(a){var b,c=[];"undefined"!=typeof this.gamepads[a.index]&&delete this.gamepads[a.index];for(b=0;b<this.gamepads.length;b++)"undefined"!=typeof this.gamepads[b]&&(c[b]=this.gamepads[b]);this.gamepads=c;this._fire(h.Event.DISCONNECTED,a)};h.prototype._resolveControllerType=function(a){a=a.toLowerCase();return-1!==a.indexOf("playstation")?h.Type.PLAYSTATION:-1!==a.indexOf("logitech")||-1!==a.indexOf("wireless gamepad")?h.Type.LOGITECH:-1!==a.indexOf("xbox")||-1!==a.indexOf("360")?h.Type.XBOX:h.Type.UNSUPPORTED};h.prototype._update=function(){var a,b,c,d,e,f,g,i;this.platform.update();for(g=0;g<this.gamepads.length;g++)if("undefined"!=typeof this.gamepads[g]){for(a in this.gamepads[g].mapping.buttons){e=this.gamepads[g].mapping.buttons[a];f="function"==typeof e?e(this.gamepads[g],this):this.gamepads[g].buttons[e];b=f>.5?!0:!1;c=!1;for(i=0;i<this.gamepads[g].downButtons.length;i++)if(this.gamepads[g].downButtons[i]===a){c=!0;d=g;break}this.gamepads[g].state[a]=f;if(b!==c)if(f>.5){this._fire(h.Event.BUTTON_DOWN,{gamepad:this.gamepads[g],mapping:e,control:a});this.gamepads[g].downButtons.push(a)}else if(.5>f){this._fire(h.Event.BUTTON_UP,{gamepad:this.gamepads[g],mapping:e,control:a});this.gamepads[g].downButtons.splice(d,1)}0!==f&&1!==f&&f!==this.gamepads[g].lastState[a]&&this._fire(h.Event.AXIS_CHANGED,{gamepad:this.gamepads[g],mapping:e,axis:a,value:f});this.gamepads[g].lastState[a]=f}for(a in this.gamepads[g].mapping.axes){e=this.gamepads[g].mapping.axes[a];f="function"==typeof e?e(this.gamepads[g],this):this._applyDeadzoneMaximize(this.gamepads[g].axes[e]);this.gamepads[g].state[a]=f;f!==this.gamepads[g].lastState[a]&&this._fire(h.Event.AXIS_CHANGED,{gamepad:this.gamepads[g],mapping:e,axis:a,value:f});this.gamepads[g].lastState[a]=f}}this.gamepads.length>0&&this._fire(h.Event.TICK,this.gamepads)};h.prototype._applyDeadzoneMaximize=function(a,b,c){b="undefined"!=typeof b?b:this.deadzone;c="undefined"!=typeof c?c:this.maximizeThreshold;a>=0?b>a?a=0:a>c&&(a=1):a>-b?a=0:-c>a&&(a=-1);return a};a.Gamepad=h}("undefined"!=typeof module&&module.exports||window);