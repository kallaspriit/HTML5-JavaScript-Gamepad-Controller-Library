!function(a){"use strict";var b=function(){this.gamepads=[];this.listeners={};this.platform=null;this.deadzone=.03;this.maximizeThreshold=.97};b.Platform={UNSUPPORTED:"unsupported",WEBKIT:"webkit",FIREFOX:"firefox"};b.Type={PLAYSTATION:"playstation",LOGITECH:"logitech",XBOX:"xbox",UNSUPPORTED:"unsupported"};b.Event={CONNECTED:"connected",UNSUPPORTED:"unsupported",DISCONNECTED:"disconnected",TICK:"tick",BUTTON_DOWN:"button-down",BUTTON_UP:"button-up",AXIS_CHANGED:"axis-changed"};b.Mapping={PLAYSTATION_FIREFOX:{buttons:{CROSS:14,CIRCLE:13,SQUARE:15,TRIANGLE:12,LB1:10,RB1:11,LEFT_STICK:1,RIGHT_STICK:2,START:3,SELECT:0,HOME:16,DPAD_UP:4,DPAD_DOWN:6,DPAD_LEFT:7,DPAD_RIGHT:5},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},PLAYSTATION_WEBKIT:{buttons:{CROSS:0,CIRCLE:1,SQUARE:2,TRIANGLE:3,LB1:4,RB1:5,LB2:6,RB2:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,SELECT:8,HOME:16,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},LOGITECH_FIREFOX:{buttons:{A:0,B:1,X:2,Y:3,LB:4,RB:5,LEFT_STICK:8,RIGHT_STICK:9,START:7,BACK:6,HOME:10,DPAD_UP:11,DPAD_DOWN:12,DPAD_LEFT:13,DPAD_RIGHT:14},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:3,RIGHT_STICK_Y:4,LEFT_TRIGGER:function(a,b){return a.axes[2]>0?b._applyDeadzoneMaximize(a.axes[2]):0},RIGHT_TRIGGER:function(a,b){return a.axes[2]<0?b._applyDeadzoneMaximize(-1*a.axes[2]):0}}},LOGITECH_WEBKIT:{buttons:{A:1,B:2,X:0,Y:3,LB:4,RB:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,BACK:8,HOME:10,DPAD_UP:11,DPAD_DOWN:12,DPAD_LEFT:13,DPAD_RIGHT:14},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},XBOX:{buttons:{A:0,B:1,X:2,Y:3,LB:4,RB:5,LEFT_TRIGGER:6,RIGHT_TRIGGER:7,LEFT_STICK:10,RIGHT_STICK:11,START:9,BACK:8,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,HOME:16},axes:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}}};b.prototype.init=function(){this.platform=this._resolvePlatform();switch(this.platform){case b.Platform.WEBKIT:this._setupWebkit();break;case b.Platform.FIREFOX:this._setupFirefox();break;case b.Platform.UNSUPPORTED:return!1}"undefined"==typeof a.requestAnimationFrame&&(a.requestAnimationFrame=a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame);this._update();return!0};b.prototype.bind=function(a,b){"undefined"==typeof this.listeners[a]&&(this.listeners[a]=[]);this.listeners[a].push(b);return this};b.prototype.unbind=function(a,b){if("undefined"!=typeof a){if("undefined"!=typeof b){if("undefined"==typeof this.listeners[a])return!1;for(var c=0;c<this.listeners[a].length;c++)if(this.listeners[a][c]===b){this.listeners[a].splice(c,1);return!0}return!1}this.listeners[a]=[]}else this.listeners={}};b.prototype.count=function(){return this.gamepads.length};b.prototype._fire=function(a,b){if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c].apply(this.listeners[a][c],[b])};b.prototype._resolvePlatform=function(){return"undefined"!=typeof a.navigator.webkitGamepads||"undefined"!=typeof a.navigator.webkitGetGamepads?b.Platform.WEBKIT:b.Platform.FIREFOX};b.prototype._setupWebkit=function(){};b.prototype._setupFirefox=function(){var b=this;a.addEventListener("MozGamepadConnected",function(a){b._connect(a.gamepad)});a.addEventListener("MozGamepadDisconnected",function(a){b._disconnect(a.gamepad)})};b.prototype._getMapping=function(a){switch(a){case b.Type.PLAYSTATION:return this.platform===b.Platform.FIREFOX?b.Mapping.PLAYSTATION_FIREFOX:this.platform===b.Platform.WEBKIT?b.Mapping.PLAYSTATION_WEBKIT:null;case b.Type.LOGITECH:return this.platform===b.Platform.FIREFOX?b.Mapping.LOGITECH_FIREFOX:this.platform===b.Platform.WEBKIT?b.Mapping.LOGITECH_WEBKIT:null;case b.Type.XBOX:return b.Mapping.XBOX}return null};b.prototype._connect=function(a){a.type=this._resolveControllerType(a.id);if(a.type===b.Type.UNSUPPORTED){this._fire(b.Event.UNSUPPORTED,a);return!1}a.mapping=this._getMapping(a.type);if(null===a.mapping){this._fire(b.Event.UNSUPPORTED,a);return!1}a.state={};a.lastState={};a.downButtons=[];var c,d;for(c in a.mapping.buttons){a.state[c]=0;a.lastState[c]=0}for(d in a.mapping.axes){a.state[d]=0;a.lastState[d]=0}this.gamepads[a.index]=a;this._fire(b.Event.CONNECTED,a);return!0};b.prototype._disconnect=function(a){var c,d=[];"undefined"!=typeof this.gamepads[a.index]&&delete this.gamepads[a.index];for(c=0;c<this.gamepads.length;c++)"undefined"!=typeof this.gamepads[c]&&(d[c]=this.gamepads[c]);this.gamepads=d;this._fire(b.Event.DISCONNECTED,a)};b.prototype._resolveControllerType=function(a){a=a.toLowerCase();return-1!==a.indexOf("playstation")?b.Type.PLAYSTATION:-1!==a.indexOf("logitech")||-1!==a.indexOf("wireless gamepad")?b.Type.LOGITECH:-1!==a.indexOf("xbox")||-1!==a.indexOf("360")?b.Type.XBOX:b.Type.UNSUPPORTED};b.prototype._update=function(){var c,d,e,f,g,h,i,j,k=this;switch(this.platform){case b.Platform.WEBKIT:this._updateWebkit();break;case b.Platform.FIREFOX:this._updateFirefox()}for(i=0;i<this.gamepads.length;i++)if("undefined"!=typeof this.gamepads[i]){for(c in this.gamepads[i].mapping.buttons){g=this.gamepads[i].mapping.buttons[c];h="function"==typeof g?g(this.gamepads[i],this):this.gamepads[i].buttons[g];d=h>.5?!0:!1;e=!1;for(j=0;j<this.gamepads[i].downButtons.length;j++)if(this.gamepads[i].downButtons[j]===c){e=!0;f=i;break}this.gamepads[i].state[c]=h;if(d!==e)if(h>.5){this._fire(b.Event.BUTTON_DOWN,{gamepad:this.gamepads[i],mapping:g,control:c});this.gamepads[i].downButtons.push(c)}else if(.5>h){this._fire(b.Event.BUTTON_UP,{gamepad:this.gamepads[i],mapping:g,control:c});this.gamepads[i].downButtons.splice(f,1)}0!==h&&1!==h&&h!==this.gamepads[i].lastState[c]&&this._fire(b.Event.AXIS_CHANGED,{gamepad:this.gamepads[i],mapping:g,axis:c,value:h});this.gamepads[i].lastState[c]=h}for(c in this.gamepads[i].mapping.axes){g=this.gamepads[i].mapping.axes[c];h="function"==typeof g?g(this.gamepads[i],this):this._applyDeadzoneMaximize(this.gamepads[i].axes[g]);this.gamepads[i].state[c]=h;h!==this.gamepads[i].lastState[c]&&this._fire(b.Event.AXIS_CHANGED,{gamepad:this.gamepads[i],mapping:g,axis:c,value:h});this.gamepads[i].lastState[c]=h}}this.gamepads.length>0&&this._fire(b.Event.TICK,this.gamepads);a.requestAnimationFrame(function(){k._update()})};b.prototype._updateWebkit=function(){var b;if("object"==typeof a.navigator.webkitGamepads)b=a.navigator.webkitGamepads;else{if("function"!=typeof a.navigator.webkitGetGamepads)return;b=a.navigator.webkitGetGamepads()}if(b.length!==this.gamepads.length){var c,d;for(d=0;d<b.length;d++){c=b[d];null!==c&&"undefined"!=typeof c&&"undefined"==typeof this.gamepads[c.index]&&this._connect(c)}for(d=0;d<this.gamepads.length;d++)null!==this.gamepads[d]&&"undefined"!=typeof this.gamepads[d]&&"undefined"==typeof b[d]&&this._disconnect(this.gamepads[d])}};b.prototype._updateFirefox=function(){};b.prototype._applyDeadzoneMaximize=function(a,b,c){b="undefined"!=typeof b?b:this.deadzone;c="undefined"!=typeof c?c:this.maximizeThreshold;a>=0?b>a?a=0:a>c&&(a=1):a>-b?a=0:-c>a&&(a=-1);return a};a.Gamepad=b}(window);